<%- include('../partials/header') %>
<section class="panel">
  <h2>Shop Mode</h2>
  <p>Use the PC webcam to scan a student QR card for checkout.</p>
  <div id="qr-reader" class="scan-reader"></div>
  <div class="scan-controls">
    <button class="button" id="toggleScan">Stop Camera</button>
  </div>
  <div id="scanMessage" class="notice"></div>
</section>

<script src="https://unpkg.com/html5-qrcode" defer></script>
<script>
  const toggleBtn = document.getElementById('toggleScan');
  const message = document.getElementById('scanMessage');
  let qrScanner = null;
  let isStarting = false;
  let hasScanned = false;
  let isRunning = false;

  function setMessage(text) {
    message.textContent = text;
  }

  function extractQrId(text) {
    try {
      const url = new URL(text);
      const parts = url.pathname.split('/');
      const index = parts.indexOf('s');
      if (index !== -1 && parts[index + 1]) {
        return parts[index + 1];
      }
    } catch (error) {
      // Not a full URL
    }

    if (text.includes('/s/')) {
      const parts = text.split('/s/');
      return parts[1] || text;
    }

    return text;
  }

  function startScanner() {
    if (isStarting || isRunning) {
      return;
    }
    if (!window.Html5Qrcode) {
      setMessage('Loading scanner...');
      setTimeout(startScanner, 200);
      return;
    }

    isStarting = true;
    hasScanned = false;
    qrScanner = qrScanner || new Html5Qrcode('qr-reader');
    qrScanner
      .start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: { width: 208, height: 208 } },
        (decodedText) => {
          if (hasScanned) return;
          hasScanned = true;
          const qrId = extractQrId(decodedText);
          window.location.href = `/s/${qrId}`;
        },
        () => {}
      )
      .then(() => {
        setMessage('Camera active. Hold a QR code steady.');
        isRunning = true;
        toggleBtn.textContent = 'Stop Camera';
        localStorage.setItem('scanAutoStart', '1');
      })
      .catch((err) => {
        setMessage(`Camera error: ${err}`);
      })
      .finally(() => {
        isStarting = false;
      });
  }

  function stopScanner() {
    if (!qrScanner || !isRunning) {
      return;
    }
    qrScanner
      .stop()
      .then(() => {
        qrScanner.clear();
        setMessage('Camera stopped.');
        isRunning = false;
        toggleBtn.textContent = 'Start Camera';
        localStorage.removeItem('scanAutoStart');
      })
      .catch((err) => {
        setMessage(`Stop error: ${err}`);
      });
  }

  toggleBtn.addEventListener('click', () => {
    if (isRunning) {
      stopScanner();
    } else {
      startScanner();
    }
  });

  startScanner();
</script>
<%- include('../partials/footer') %>
