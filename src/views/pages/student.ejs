<%- include('../partials/header') %>
<section class="panel student-panel">
  <div class="student-toolbar compact">
    <a class="button small" href="/scan">Back to Scanner</a>
    <div class="student-timer muted">
      Return in <strong id="scannerCountdown">60</strong>s
    </div>
  </div>
  <div class="student-header">
    <div>
      <h2><%= student.name %></h2>
    </div>
    <div class="balance-card">
      <div class="balance-line">
        <span class="label"><%= labels.shekels_label %></span>
        <span class="value"><%= student.balance %><%= currencySymbols.shekels %></span>
      </div>
      <div class="balance-line">
        <span class="label"><%= labels.talents_label %></span>
        <span class="value"><%= currencySymbols.talents %><%= student.talents %></span>
      </div>
      <div class="balance-note">
        <%= economy.shekels_per_talent %><%= currencySymbols.shekels %> <%= labels.shekels_label %> = <%= currencySymbols.talents %>1 <%= labels.talents_label %>
      </div>
    </div>
  </div>

</section>

<section class="panel">
  <h3>Spend <%= labels.shekels_label %></h3>
  <% if (items.length === 0) { %>
    <p class="muted">No active items yet.</p>
  <% } %>
  <div class="item-grid">
    <% items.forEach((item) => { %>
      <% const rarity = item.rarity || 'common'; %>
      <% const isCommon = rarity === 'common'; %>
      <% const isGroupBuy = item.type === 'group_buy'; %>
      <% const isComplete = Boolean(item.isComplete); %>
      <% const canBuy = Boolean(item.canBuy); %>
      <% const soldOut = Boolean(item.soldOut); %>
      <% const costText = `${item.price_shekels}${currencySymbols.shekels}`; %>
      <% const buyInText = `${item.buyInCost}${currencySymbols.shekels}`; %>
      <% const progressText = `${item.progressAmount} / ${item.goalAmount} ${labels.shekels_label}`; %>
      <div
        class="item-card shop-card rarity-<%= rarity %><%= isCommon ? '' : ' has-rarity' %><%= canBuy ? ' is-clickable' : ' is-disabled' %><%= isGroupBuy ? ' group-buy-card' : '' %><%= isComplete ? ' is-complete' : '' %>"
        role="button"
        tabindex="0"
        aria-label="<%= isGroupBuy ? 'Contribute to' : 'Buy' %> <%= item.name %>"
        aria-disabled="<%= canBuy ? 'false' : 'true' %>"
        data-can-buy="<%= canBuy ? 'true' : 'false' %>"
        data-form-id="buy-form-<%= item.id %>"
        <% if (item.rarityTokens) { %>
          style="--rarity-base: <%= item.rarityTokens.base %>; --rarity-accent: <%= item.rarityTokens.accent %>; --rarity-border: <%= item.rarityTokens.border %>; --rarity-strip-from: <%= item.rarityTokens.stripFrom %>; --rarity-strip-to: <%= item.rarityTokens.stripTo %>; --rarity-metal-from: <%= item.rarityTokens.labelFrom %>; --rarity-metal-to: <%= item.rarityTokens.labelTo %>; --rarity-button-bg: <%= item.rarityTokens.buttonBg %>; --rarity-button-text: <%= item.rarityTokens.buttonText %>; --rarity-button-border: <%= item.rarityTokens.buttonBorder %>; --rarity-shadow: <%= item.rarityTokens.shadow %>; --rarity-hover-shadow: <%= item.rarityTokens.hoverShadow %>; --rarity-glow: <%= item.rarityTokens.glow %>; --rarity-focus: <%= item.rarityTokens.focus %>;"
        <% } %>
      >
        <% if (!isCommon) { %>
          <span class="rarity-strip" aria-hidden="true"></span>
        <% } %>
        <div class="item-card-content">
          <div class="item-text">
            <div class="item-header">
              <h4><%= item.name %></h4>
              <% if (!isCommon) { %>
                <span class="rarity-icon rarity-icon-<%= rarity %>" aria-hidden="true">
                  <% if (rarity === 'uncommon') { %>
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 3c4 0 7 3 7 7 0 6-7 11-7 11S5 16 5 10c0-4 3-7 7-7z"></path>
                      <path d="M12 7c-1.8 1.7-2.5 4.1-2.4 6.4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
                    </svg>
                  <% } else if (rarity === 'rare') { %>
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <defs>
                        <linearGradient id="rarity-metal-gradient" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="0%" stop-color="var(--rarity-metal-from)"></stop>
                          <stop offset="100%" stop-color="var(--rarity-metal-to)"></stop>
                        </linearGradient>
                      </defs>
                      <path d="M12 3l7 7-7 11L5 10l7-7z" fill="url(#rarity-metal-gradient)"></path>
                    </svg>
                  <% } else { %>
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <defs>
                        <linearGradient id="rarity-metal-gradient" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="0%" stop-color="var(--rarity-metal-from)"></stop>
                          <stop offset="100%" stop-color="var(--rarity-metal-to)"></stop>
                        </linearGradient>
                      </defs>
                      <path d="M4 8l4 3 4-6 4 6 4-3v9H4V8z" fill="url(#rarity-metal-gradient)"></path>
                      <path d="M4 17h16v2H4z" fill="url(#rarity-metal-gradient)"></path>
                    </svg>
                  <% } %>
                </span>
              <% } %>
            </div>
            <span class="rarity-label rarity-<%= rarity %>"><%= rarity.replace(/^\w/, (c) => c.toUpperCase()) %></span>
            <div class="item-meta-row">
              <span class="muted"><%= item.category %></span>
            </div>
            <% if (isGroupBuy) { %>
              <div class="group-buy-progress">
                <div class="group-buy-bar" role="progressbar"
                  aria-valuemin="0"
                  aria-valuemax="<%= item.goalAmount %>"
                  aria-valuenow="<%= item.progressAmount %>">
                  <span style="width: <%= Math.min(100, Math.round((item.goalAmount ? (item.progressAmount / item.goalAmount) * 100 : 0))) %>%"></span>
                </div>
                <div class="group-buy-text"><%= progressText %></div>
              </div>
            <% } %>
          </div>
          <% if (isGroupBuy && isComplete) { %>
            <div class="group-buy-complete">COMPLETE</div>
          <% } else { %>
            <form method="post" action="<%= isGroupBuy ? `/s/${student.qr_id}/group-buy/${item.id}/contribute` : `/s/${student.qr_id}/buy` %>" id="buy-form-<%= item.id %>" class="buy-form">
              <input type="hidden" name="item_id" value="<%= item.id %>" />
              <button class="button buy-button<%= isCommon ? '' : ' rarity-accent' %>" type="submit" <%= canBuy ? '' : 'disabled' %>>
                <% if (!canBuy) { %>
                  <%= soldOut ? 'Sold out' : `Not enough ${currencySymbols.shekels}` %>
                <% } else { %>
                  Buy &mdash; <%= isGroupBuy ? buyInText : costText %>
                <% } %>
              </button>
            </form>
          <% } %>
        </div>
      </div>
    <% }) %>
  </div>
</section>

<section class="panel">
  <h3>Recent Activity</h3>
  <% if (transactions.length === 0) { %>
    <p class="muted">No activity yet.</p>
  <% } else { %>
    <ul class="activity-list">
      <% transactions.forEach((tx) => { %>
        <li>
          <span class="activity-time"><%= tx.created_at.replace('T', ' ').slice(0, 16) %></span>
          <span class="activity-reason"><%= tx.reason || tx.type %></span>
          <span class="activity-amount"><%= tx.amount_shekels %><%= currencySymbols.shekels %></span>
        </li>
      <% }) %>
    </ul>
  <% } %>
</section>

<div class="toast" id="shopToast" role="status" aria-live="polite"></div>
<script>
  const countdownEl = document.getElementById('scannerCountdown');
  if (countdownEl) {
    let secondsLeft = 60;
    const tick = () => {
      secondsLeft -= 1;
      if (secondsLeft <= 0) {
        window.location.href = '/scan';
        return;
      }
      countdownEl.textContent = secondsLeft.toString();
    };
    setInterval(tick, 1000);
  }

  const shopCards = document.querySelectorAll('.shop-card');
  const triggerPurchase = (form) => {
    if (!form) return;
    if (typeof form.requestSubmit === 'function') {
      form.requestSubmit();
    } else {
      form.submit();
    }
  };

  shopCards.forEach((card) => {
    const formId = card.dataset.formId;
    const canBuy = card.dataset.canBuy === 'true';
    const form = document.getElementById(formId);
    const button = form ? form.querySelector('button') : null;

    card.addEventListener('click', (event) => {
      if (!canBuy) return;
      if (event.target.closest('button')) return;
      triggerPurchase(form);
    });

    card.addEventListener('keydown', (event) => {
      if (!canBuy) return;
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        triggerPurchase(form);
      }
    });

    if (button) {
      button.addEventListener('click', (event) => {
        event.stopPropagation();
        if (!canBuy) {
          event.preventDefault();
          return;
        }
        event.preventDefault();
        triggerPurchase(form);
      });
    }
  });

  const purchaseNotice = <%- JSON.stringify(purchaseNotice || null) %>;
  if (purchaseNotice) {
    const toast = document.getElementById('shopToast');
    if (toast) {
      const verb = purchaseNotice.type === 'group_buy' ? 'Contributed to' : 'Purchased';
      toast.textContent = `${verb} ${purchaseNotice.name} (${purchaseNotice.price}<%= currencySymbols.shekels %>)`;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2800);
    }
    if (window.history && window.history.replaceState) {
      const url = new URL(window.location.href);
      url.searchParams.delete('purchased');
      window.history.replaceState({}, '', url.toString());
    }
  }
</script>

<%- include('../partials/footer') %>
