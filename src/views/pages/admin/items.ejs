<%- include('../../partials/header') %>
<section class="panel">
  <div class="panel-header">
    <h2>Items</h2>
    <div class="button-row">
      <a class="button" href="/admin/items/menu?autoprint=1" target="_blank" rel="noopener">Print Menu</a>
      <button class="button" type="button" id="openAddItem">Add Item</button>
    </div>
  </div>
</section>

<section class="panel">
  <h3>All Items</h3>
  <% if (items.length === 0) { %>
    <p class="muted">No items yet.</p>
  <% } else { %>
    <% const formatRarity = (rarity) => (rarity || 'common').replace(/^\w/, (c) => c.toUpperCase()); %>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Rarity</th>
            <th class="col-cost">Cost (<%= currencySymbols.shekels %>)</th>
            <th class="col-stock">Stock</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% items.forEach((item, index) => { %>
            <% const isFirst = index === 0; %>
            <% const isLast = index === items.length - 1; %>
            <tr>
              <td><%= item.name %></td>
              <td><%= item.category %></td>
              <td>
                <% if ((item.rarity || 'common') === 'common') { %>
                  Common
                <% } else { %>
                  <span class="rarity-badge rarity-<%= item.rarity %>"><%= formatRarity(item.rarity) %></span>
                <% } %>
              </td>
              <td class="col-cost"><%= item.price_shekels %><%= currencySymbols.shekels %></td>
              <td class="col-stock"><%= item.inventory %></td>
              <td><%= item.active ? 'Active' : 'Inactive' %></td>
              <td>
                <form method="post" action="/admin/items/<%= item.id %>/move" class="inline-form">
                  <input type="hidden" name="direction" value="up" />
                  <button class="button small icon-button" type="submit" aria-label="Move item up" title="Move item up" <%= isFirst ? 'disabled' : '' %>>
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 5l7 7H5l7-7z"></path>
                    </svg>
                  </button>
                </form>
                <form method="post" action="/admin/items/<%= item.id %>/move" class="inline-form">
                  <input type="hidden" name="direction" value="down" />
                  <button class="button small icon-button" type="submit" aria-label="Move item down" title="Move item down" <%= isLast ? 'disabled' : '' %>>
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 19l-7-7h14l-7 7z"></path>
                    </svg>
                  </button>
                </form>
                <a class="button small icon-button" href="/admin/items/<%= item.id %>/edit" aria-label="Edit item" title="Edit item">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M3 17.25V21h3.75L19.81 7.94l-3.75-3.75L3 17.25z"></path>
                    <path d="M20.71 6.04a1 1 0 0 0 0-1.41l-1.34-1.34a1 1 0 0 0-1.41 0l-1.13 1.13 3.75 3.75 1.13-1.13z"></path>
                  </svg>
                </a>
                <form method="post" action="/admin/items/<%= item.id %>/delete" class="inline-form">
                  <button class="button small icon-button" type="submit" aria-label="Delete item" title="Delete item" onclick="return confirm('Delete this item?')">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M6 7h12l-1 14H7L6 7z"></path>
                      <path d="M9 4h6l1 2H8l1-2z"></path>
                    </svg>
                  </button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>
</section>

<div class="modal-backdrop" id="addItemModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="addItemTitle">
    <div class="modal-header">
      <h3 id="addItemTitle">Add Item</h3>
      <button type="button" class="icon-button" id="closeAddItem" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <% if (error) { %>
      <div class="notice error"><%= error %></div>
    <% } %>
    <form method="post" action="/admin/items" class="form-grid">
      <label class="form-label">Name
        <input type="text" name="name" class="text-input" required />
      </label>
      <label class="form-label">Type
        <select name="type" class="text-input" id="itemTypeSelect">
          <option value="standard" selected>Standard</option>
          <option value="group_buy">Group Goal</option>
        </select>
      </label>
      <label class="form-label standard-field">Cost (<%= currencySymbols.shekels %>)
        <input type="number" name="price_shekels" class="text-input" min="0" />
      </label>
      <label class="form-label standard-field">Stock
        <input type="number" name="inventory" class="text-input" min="0" value="0" />
      </label>
      <label class="form-label group-buy-field">Goal Amount (<%= currencySymbols.shekels %>)
        <input type="number" name="goal_amount" class="text-input" min="1" />
      </label>
      <label class="form-label group-buy-field">Cost (per contribution) (<%= currencySymbols.shekels %>)
        <input type="number" name="buy_in_cost" class="text-input" min="1" />
      </label>
      <label class="form-label group-buy-field">Progress Amount (<%= currencySymbols.shekels %>)
        <input type="number" name="progress_amount" class="text-input" min="0" value="0" />
      </label>
      <label class="form-label">Category
        <input type="text" name="category" class="text-input" value="snack" />
      </label>
      <label class="form-label">Rarity
        <select name="rarity" class="text-input">
          <option value="common" selected>Common</option>
          <option value="uncommon">Uncommon</option>
          <option value="rare">Rare</option>
          <option value="legendary">Legendary</option>
        </select>
      </label>
      <label class="checkbox">
        <input type="checkbox" name="active" checked /> Active
      </label>
      <div class="modal-actions">
        <button class="button" type="submit">Add Item</button>
        <button class="button" type="button" id="cancelAddItem">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  const openAddItem = document.getElementById('openAddItem');
  const addItemModal = document.getElementById('addItemModal');
  const closeAddItem = document.getElementById('closeAddItem');
  const cancelAddItem = document.getElementById('cancelAddItem');
  const itemTypeSelect = document.getElementById('itemTypeSelect');
  const groupBuyFields = addItemModal.querySelectorAll('.group-buy-field');
  const standardFields = addItemModal.querySelectorAll('.standard-field');
  const shouldOpen = <%= error ? 'true' : 'false' %>;

  function openModal() {
    addItemModal.classList.add('active');
    addItemModal.setAttribute('aria-hidden', 'false');
    document.body.classList.add('modal-open');
    const firstInput = addItemModal.querySelector('input, select, textarea');
    if (firstInput) {
      firstInput.focus();
    }
  }

  function closeModal() {
    addItemModal.classList.remove('active');
    addItemModal.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('modal-open');
  }

  function toggleItemTypeFields() {
    const isGroupBuy = itemTypeSelect && itemTypeSelect.value === 'group_buy';
    groupBuyFields.forEach((field) => {
      field.style.display = isGroupBuy ? 'block' : 'none';
      const input = field.querySelector('input');
      if (input) {
        input.required = isGroupBuy && (input.name === 'goal_amount' || input.name === 'buy_in_cost');
      }
    });
    standardFields.forEach((field) => {
      const input = field.querySelector('input');
      if (input) {
        input.required = !isGroupBuy;
      }
      field.style.display = isGroupBuy ? 'none' : 'block';
    });
  }

  openAddItem.addEventListener('click', openModal);
  closeAddItem.addEventListener('click', closeModal);
  cancelAddItem.addEventListener('click', closeModal);
  if (itemTypeSelect) {
    itemTypeSelect.addEventListener('change', toggleItemTypeFields);
  }
  addItemModal.addEventListener('click', (event) => {
    if (event.target === addItemModal) {
      closeModal();
    }
  });
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && addItemModal.classList.contains('active')) {
      closeModal();
    }
  });

  if (shouldOpen) {
    openModal();
  }

  toggleItemTypeFields();
</script>
<%- include('../../partials/footer') %>
