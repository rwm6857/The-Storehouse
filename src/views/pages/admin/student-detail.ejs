<%- include('../../partials/header') %>
<section class="panel">
  <div class="panel-header">
    <h2><%= student.name %></h2>
    <div class="button-row">
      <a class="button" href="/s/<%= student.qr_id %>">Open Public View</a>
      <a class="button icon-button" href="/admin/students/<%= student.id %>/edit" aria-label="Edit student" title="Edit student">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 17.25V21h3.75L19.81 7.94l-3.75-3.75L3 17.25z"></path>
          <path d="M20.71 6.04a1 1 0 0 0 0-1.41l-1.34-1.34a1 1 0 0 0-1.41 0l-1.13 1.13 3.75 3.75 1.13-1.13z"></path>
        </svg>
      </a>
      <form method="post" action="/admin/students/<%= student.id %>/delete" class="inline-form">
        <button class="button icon-button" type="submit" aria-label="Delete student" title="Delete student" onclick="return confirm('Delete this student and all transactions?')">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M6 7h12l-1 14H7L6 7z"></path>
            <path d="M9 4h6l1 2H8l1-2z"></path>
          </svg>
        </button>
      </form>
    </div>
  </div>
  <div class="student-detail-grid">
    <div>
      <p><strong>Status:</strong> <%= student.active ? 'Active' : 'Inactive' %></p>
      <p><strong><%= labels.shekels_label %>:</strong> <%= student.balance %><%= currencySymbols.shekels %></p>
      <p><strong><%= labels.talents_label %>:</strong> <%= currencySymbols.talents %><%= student.talents %></p>
      <p><strong>Notes:</strong> <%= student.notes || 'â€”' %></p>
      <p><strong>QR ID:</strong> <%= student.qr_id %></p>
      <form method="post" action="/admin/students/<%= student.id %>/regenerate" class="inline-form">
        <button class="button" type="submit" onclick="return confirm('Regenerate QR ID? Old cards will stop working.')">Regenerate QR ID</button>
      </form>
    </div>
    <div class="qr-card">
      <img src="/qr/<%= student.qr_id %>.png" alt="QR code" />
      <a class="button" href="/qr/<%= student.qr_id %>.png?download=1">Download QR PNG</a>
    </div>
  </div>
</section>

<section class="panel admin-panel">
  <h3>Add <%= labels.shekels_label %></h3>
  <div class="earn-grid">
    <form method="post" action="/s/<%= student.qr_id %>/earn">
      <input type="hidden" name="type" value="attendance" />
      <button class="button big" type="submit">+ Attendance (<%= economy.attendance_shekels %>)</button>
    </form>
    <form method="post" action="/s/<%= student.qr_id %>/earn">
      <input type="hidden" name="type" value="participation" />
      <button class="button big" type="submit">+ Participation (<%= economy.participation_shekels %>)</button>
    </form>
    <form method="post" action="/s/<%= student.qr_id %>/earn">
      <input type="hidden" name="type" value="memory" />
      <button class="button big" type="submit">+ Memory Verse (<%= economy.memory_verse_shekels %>)</button>
    </form>
    <form method="post" action="/s/<%= student.qr_id %>/earn">
      <input type="hidden" name="type" value="brought_bible" />
      <button class="button big" type="submit">+ Brought Bible (1)</button>
    </form>
    <form method="post" action="/s/<%= student.qr_id %>/earn">
      <input type="hidden" name="type" value="brought_friend" />
      <button class="button big" type="submit">+ Brought Friend (3)</button>
    </form>
    <form method="post" action="/s/<%= student.qr_id %>/earn">
      <input type="hidden" name="type" value="bonus" />
      <button class="button big" type="submit">ðŸŽ² Bonus</button>
    </form>
  </div>
</section>

<section class="panel admin-panel">
  <h3>Admin Controls</h3>
  <div class="admin-actions">
    <form method="post" action="/admin/students/<%= student.id %>/adjust" class="inline-form">
      <input type="hidden" name="qr_id" value="<%= student.qr_id %>" />
      <input type="hidden" name="amount" value="1" />
      <input type="hidden" name="reason" value="Add one shekel" />
      <button class="button" type="submit">Add one shekel</button>
    </form>

    <form method="post" action="/admin/students/<%= student.id %>/adjust" class="inline-form">
      <input type="hidden" name="qr_id" value="<%= student.qr_id %>" />
      <input type="hidden" name="amount" value="-1" />
      <input type="hidden" name="reason" value="Remove one shekel" />
      <button class="button" type="submit">Remove one shekel</button>
    </form>

    <form method="post" action="/admin/students/<%= student.id %>/adjust" class="inline-form">
      <input type="hidden" name="qr_id" value="<%= student.qr_id %>" />
      <input type="number" name="amount" class="text-input" placeholder="Amount" required />
      <input type="text" name="reason" class="text-input" placeholder="Reason" required />
      <button class="button" type="submit">Manual Adjust</button>
    </form>

    <form method="post" action="/admin/students/<%= student.id %>/undo" class="inline-form">
      <input type="hidden" name="qr_id" value="<%= student.qr_id %>" />
      <button class="button" type="submit">Undo Last Transaction</button>
    </form>

    <form method="post" action="/admin/students/<%= student.id %>/convert" class="inline-form">
      <input type="hidden" name="qr_id" value="<%= student.qr_id %>" />
      <button class="button" type="submit">Convert <%= economy.shekels_per_talent %><%= currencySymbols.shekels %> <%= labels.shekels_label %> to <%= currencySymbols.talents %>1 <%= labels.talents_label %></button>
    </form>
  </div>
  <a class="button icon-button" href="/admin/students/<%= student.id %>/edit" aria-label="Edit student" title="Edit student">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M3 17.25V21h3.75L19.81 7.94l-3.75-3.75L3 17.25z"></path>
      <path d="M20.71 6.04a1 1 0 0 0 0-1.41l-1.34-1.34a1 1 0 0 0-1.41 0l-1.13 1.13 3.75 3.75 1.13-1.13z"></path>
    </svg>
  </a>
</section>

<section class="panel">
  <h3>Recent Transactions</h3>
  <% if (transactions.length === 0) { %>
    <p class="muted">No transactions yet.</p>
  <% } else { %>
    <ul class="activity-list">
      <% transactions.forEach((tx) => { %>
        <li>
          <span class="activity-time"><%= tx.created_at.replace('T', ' ').slice(0, 16) %></span>
          <span class="activity-reason"><%= tx.reason || tx.type %></span>
          <span class="activity-amount"><%= tx.amount_shekels %><%= currencySymbols.shekels %></span>
        </li>
      <% }) %>
    </ul>
  <% } %>
</section>
<%- include('../../partials/footer') %>
